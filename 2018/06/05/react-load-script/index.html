<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>React 使用 Promise 等待外部脚本加载完成再执行代码</title>
  <link rel="stylesheet" type="text/css" href="/css/main.css">
</head>
<body>

  <main class="container" role="main">
    <div class="article-head">
      <h1>React 使用 Promise 等待外部脚本加载完成再执行代码</h1>
      <span class="blog-post-date">June 5, 2018</span>
    </div>
    <div class="blog-post-content">
        <p>有时我们做项目时，需要引入外部的脚本，有些是需要等脚本加载完才可以执行相关的代码。我们在 React 项目中，可以用 <code>Promise</code> 来做这件事儿。</p>

<p>首先需要如下加载脚本的函数：</p>

<pre><code class="language-js">function loadScript(src) {
  return new Promise(resolve =&gt; {
    let tag = document.createElement(&quot;script&quot;)
    tag.async = true
    tag.src = src

    document.body.appendChild(tag)

    tag.addEventListener(&quot;load&quot;, function() {
      resolve()
    })
  })
}
</code></pre>

<p>当一个资源及其依赖资源已完成加载时，将触发 <code>load</code> 事件。</p>

<p>然后我们在组件的 <code>componentDidMount()</code> 里调用这个函数：</p>

<pre><code class="language-js">componentDidMount() {

  Promise.all([
    loadScript(&quot;/a.js&quot;),
    loadScript(&quot;/b.js&quot;),
    loadScript(&quot;/c.js&quot;)
  ]).then(() =&gt; {
    // your code goes here
  }
}
</code></pre>

<p>这样我们就实现了先加载完 <code>a.js</code>, <code>b.js</code>, <code>c.js</code> 这三个脚本再执行相关代码，这里我们需要加载三个脚本，用到了 <code>Promise.all(iterable)</code>, 这个方法返回一个新的 promise 对象，该 promise 对象在 iterable 参数对象里所有的 promise 对象都成功的时候才会触发成功，一旦有任何一个 iterable 里面的 promise 对象失败则立即触发该 promise 对象的失败。</p>

<p>如果只加载一个脚本，可以这样：</p>

<pre><code class="language-js">componentDidMount() {

  loadScript(&quot;/a.js&quot;).then(() =&gt; {
    // your code goes here
  }
}
</code></pre>

    </div>
  </main>

</body>
</html>